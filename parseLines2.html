<!DOCTYPE html>
<html>

<head>


	var theLongStr = "";
	
	function splitLayers(gCode){
		let hre = gCode.split(' change layer ');
		return hre;
	}
	
	function splitPerimeters(gCode){
		let hre = gCode.split('move to first perimeter point');
		console.log(hre);
		return hre;
	}
	
	function parseGcode(perimCode) {

		let cutOut = "";
		let leavIn = "";

		for (let x in perimCode){

			if (x % 2) {
				cutOut += perimCode[x];
			} else {
				leavIn += perimCode[x];
			}
			
		}

		return [leavIn,cutOut];
	}
	
	function splitSections(os){
	
		let f = os.split('; Filament gcode');
		let g = f[1].split('; Filament-specific end gcode');
		return [f[0],g[0],g[1],g[2],f[2]];
	}
	
	function reco (){
		let gString = '';
		let os = document.getElementById('inputMain').value;
		let layerHeight = document.getElementById('LH').value;
		let extrusionMultiplier = document.getElementById('EM').value;
		let sections = splitSections(os);
		let endCode = sections[2] + sections[3] + sections[4]; 
		
		gString += sections[0];

		let layers = splitLayers(sections[1]);
		
		
		for (let y in layers){
			if ((y > 1)&&(y < (layers.length-1))){
				let perimeters = splitPerimeters(layers[y]);
				let curStr = parseGcode(perimeters);
					
					let tempStr = '';
					let b = curStr[1].split('\n');
					for (let p in b){
						if (b[p].includes(' E')){
							let s = b[p].split(' E');
							let ext = parseFloat(s[1]);
							if ( y == 2) {
								ext = ext*1.5;
							} else {
								ext = ext*extrusionMultiplier;
							}
							
							ext = ext.toFixed(5);
							let rln = s[0] + ' E' + ext + ' ; raised perimeter\n';
							tempStr += rln;
						}else{
							tempStr += b[p] + '\n';
						}
					}
					let ghb = ((y*layerHeight)+(layerHeight/2));
					gString += curStr[0] + '\nG1 Z' + ghb.toFixed(3) + ' F7800.000 ; interlock height\n' + tempStr;

			}else if (y == (layers.length-1)){
				//extrusion * .5
				let perimeters = splitPerimeters(layers[y]);
				let curStr = parseGcode(perimeters);
				let tempString = '';
				
				let u = curStr[1].split('\n');
				for (let o in u){
					if (u[o].includes(' E')){
						let t = u[o].split(' E');
						let ex = parseFloat(t[1]);
						ex = ex*0.5;
						ex = ex.toFixed(5);
						let rl = t[0] + ' E' + ex + ' ; half height perimiter \n';
						tempString += rl;
					}else{
						tempString += u[o] + ' \n';
					}
				}
				gString += curStr[0] + tempString + ' ; end raised perimeters \n';
			}else {
				gString += layers[y];
			}
		}
		gString += endCode;
		
		document.getElementById('outputMain').value = gString;
	}


	
</script>

</head>

<body>

 <form id="theForm">
   <label for="LH">Layer Height:</label>
  <input type="number" id="LH" name="LH" value=".20">
     <label for="EM">Extrusion Multiplier:</label>
  <input type="number" id="EM" name="EM" value="1.050">
  <input type="button" value="do it - - - - do it - - - - do it - - - - do it - - - - do it - - - - do it - - - - do it - - - - do it - - - - do it - - - - " onclick="reco();"><br>
 <textarea rows="40" cols="60" id="inputMain"> </textarea>

 <textarea rows="40" cols="60" id="outputMain"> </textarea>


 </form>
 
 <script>
 
 	//document.getElementById("inputMain").value = "  ";
	document.getElementById("outputMain").value = "  ";
	var inPane = document.getElementById("inputMain");

</script>

</body>

</html>